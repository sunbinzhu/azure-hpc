{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "portalDnsNameLabel": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "The DNS name label. This label should be globally unique or leave empty then the deployment process will generate an unique string."
      }
    },
    "frontendServiceSku": {
      "defaultValue": "B1 Basic",
      "allowedValues": [
        "B1 Basic",
        "B2 Basic",
        "S1 Standard",
        "S2 Standard",
        "P1 Premium",
        "P2 Premium",
        "P1v2 PremiumV2",
        "P2v2 PremiumV2"
      ],
      "type": "string",
      "metadata": {
        "description": "The sku name of App service plan for the frontend service"
      }
    },
    "portalAnonymousAccess": {
      "type": "string",
      "defaultValue": "No",
      "allowedValues": [
        "Yes",
        "No"
      ],
      "metadata": {
        "description": "Specify whether you want to enable the anonymous access for the ACM portal. Choose 'Yes' only for testing purpose."
      }
    },
    "aadAuthApplicationId": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "The existing authentication application Id used to logon the portal if specified"
      }
    },
    "aadTenantId": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "The Id of the tenant in which the authentication application locates. If not specified, the current tenantId is used"
      }
    },
    "frontendImageName": {
      "defaultValue": "mcr.microsoft.com/hpcpack/hpcacm:frontend",
      "type": "string",
      "metadata": {
        "description": "Name for the frontend image"
      }
    },
    "jobMonitorImageName": {
      "defaultValue": "mcr.microsoft.com/hpcpack/hpcacm:jobmonitor",
      "type": "string",
      "metadata": {
        "description": "Name for the jobmonitor image"
      }
    },
    "jobMonitorCpuCores": {
      "defaultValue": "1.0",
      "type": "string",
      "metadata": {
        "description": "The number of CPU cores to allocate to the jobmonitor container instance."
      }
    },
    "jobMonitorMemoryInGb": {
      "defaultValue": "1.5",
      "type": "string",
      "metadata": {
        "description": "The amount of memory in GB to allocate to the jobmonitor container instance."
      }
    },
    "taskDispatcherImageName": {
      "defaultValue": "mcr.microsoft.com/hpcpack/hpcacm:taskdispatcher",
      "type": "string",
      "metadata": {
        "description": "Name for the taskdispatcher image"
      }
    },
    "taskDispatcherCpuCores": {
      "defaultValue": "1.0",
      "type": "string",
      "metadata": {
        "description": "The number of CPU cores to allocate to the taskDispatcher container instance."
      }
    },
    "taskDispatcherMemoryInGb": {
      "defaultValue": "1.5",
      "type": "string",
      "metadata": {
        "description": "The amount of memory in GB to allocate to the taskDispatcher container instance."
      }
    },
    "dashboardImageName": {
      "defaultValue": "mcr.microsoft.com/hpcpack/hpcacm:dashboard",
      "type": "string",
      "metadata": {
        "description": "Name for the dashboard image"
      }
    },
    "dashboardCpuCores": {
      "defaultValue": "1.0",
      "type": "string",
      "metadata": {
        "description": "The number of CPU cores to allocate to the dashboard container instance."
      }
    },
    "dashboardMemoryInGb": {
      "defaultValue": "1.5",
      "type": "string",
      "metadata": {
        "description": "The amount of memory in GB to allocate to the dashboard container instance."
      }
    },
    "scheduler": {
      "defaultValue": "Slurm",
      "allowedValues": [
        "Slurm",
        "PBSPro-OSS",
        "None"
      ],
      "type": "string",
      "metadata": {
        "description": "HPC scheduler to install."
      }
    },
    "adminUserName": {
      "defaultValue": "azureuser",
      "type": "string",
      "metadata": {
        "description": "User name for the Virtual Machine. Pick a valid username otherwise there will be a BadRequest error."
      }
    },
    "adminPassword": {
      "defaultValue": "",
      "type": "securestring",
      "metadata": {
        "description": "Admin password. Pick a complex password with uppercase letters, lowercase letters, digits, and symbols. The password should not be longer than 16. Otherwise you'll get a BadRequest error."
      }
    },
    "hpcUserName": {
      "defaultValue": "hpcuser",
      "type": "string",
      "metadata": {
        "description": "User for running HPC applications with shared home directory and SSH public key authentication setup.  This user cannot login from outside the cluster. Pick a valid username otherwise there will be a BadRequest error."
      }
    },
    "hpcNodeImage": {
      "defaultValue": "CentOS_7.3",
      "allowedValues": [
        "CentOS_7.1",
        "CentOS_7.3",
        "CentOS_7.4",
        "CentOS_7.1_HPC",
        "CentOS_7.3_HPC",
        "CentOS_7.4_HPC"
      ],
      "type": "string",
      "metadata": {
        "description": "The OS image offer to use, either HPC with Intel MPI or the vanilla CentOS version."
      }
    },
    "headNodeName": {
      "defaultValue": "master",
      "type": "string",
      "metadata": {
        "description": "The VM name of head node."
      }
    },
    "headNodeSize": {
      "defaultValue": "Standard_D4_v2",
      "allowedValues": [
        "Standard_A2",
        "Standard_A4",
        "Standard_A7",
        "Standard_A8",
        "Standard_A9",
        "Standard_A10",
        "Standard_A11",
        "Standard_D4",
        "Standard_D13",
        "Standard_D14",
        "Standard_DS4",
        "Standard_DS13",
        "Standard_DS14",
        "Standard_D4_v2",
        "Standard_D5_v2",
        "Standard_D11_v2",
        "Standard_D12_v2",
        "Standard_D13_v2",
        "Standard_D14_v2",
        "Standard_D15_v2",
        "Standard_DS1_v2",
        "Standard_DS2_v2",
        "Standard_DS3_v2",
        "Standard_DS4_v2",
        "Standard_DS5_v2",
        "Standard_DS11_v2",
        "Standard_DS12_v2",
        "Standard_DS13_v2",
        "Standard_DS14_v2",
        "Standard_DS15_v2",
        "Standard_F4",
        "Standard_F8",
        "Standard_F16",
        "Standard_G3",
        "Standard_G4",
        "Standard_G5",
        "Standard_GS3",
        "Standard_GS4",
        "Standard_GS5",
        "Standard_H8",
        "Standard_H16",
        "Standard_H8m",
        "Standard_H16m",
        "Standard_H16mr",
        "Standard_H16r",
        "Standard_L4",
        "Standard_L8",
        "Standard_L16",
        "Standard_L32"
      ],
      "type": "string",
      "metadata": {
        "description": "Size of the head node."
      }
    },
    "headNodeOsDiskType": {
      "defaultValue": "Standard_LRS",
      "allowedValues": [
        "Standard_LRS",
        "StandardSSD_LRS",
        "Premium_LRS"
      ],
      "type": "string",
      "metadata": {
        "description": "Head node OS Disk Account type"
      }
    },
    "workerNodeNamePrefix": {
      "defaultValue": "worker",
      "type": "string",
      "metadata": {
        "description": "The VM name prefix of the work nodes."
      }
    },
    "workerNodeSize": {
      "defaultValue": "Standard_D2_v2",
      "allowedValues": [
        "Standard_A2",
        "Standard_A3",
        "Standard_A4",
        "Standard_A5",
        "Standard_A6",
        "Standard_A7",
        "Standard_A8",
        "Standard_A9",
        "Standard_A10",
        "Standard_A11",
        "Standard_D1",
        "Standard_D2",
        "Standard_D3",
        "Standard_D4",
        "Standard_D11",
        "Standard_D12",
        "Standard_D13",
        "Standard_D14",
        "Standard_DS1",
        "Standard_DS2",
        "Standard_DS3",
        "Standard_DS4",
        "Standard_D11",
        "Standard_D12",
        "Standard_D13",
        "Standard_D14",
        "Standard_DS11",
        "Standard_DS12",
        "Standard_DS13",
        "Standard_DS14",
        "Standard_D1_v2",
        "Standard_D2_v2",
        "Standard_D3_v2",
        "Standard_D4_v2",
        "Standard_D5_v2",
        "Standard_D11_v2",
        "Standard_D12_v2",
        "Standard_D13_v2",
        "Standard_D14_v2",
        "Standard_D15_v2",
        "Standard_DS1_v2",
        "Standard_DS2_v2",
        "Standard_DS3_v2",
        "Standard_DS4_v2",
        "Standard_DS5_v2",
        "Standard_DS11_v2",
        "Standard_DS12_v2",
        "Standard_DS13_v2",
        "Standard_DS14_v2",
        "Standard_DS15_v2",
        "Standard_F1",
        "Standard_F2",
        "Standard_F4",
        "Standard_F8",
        "Standard_F16",
        "Standard_G1",
        "Standard_G2",
        "Standard_G3",
        "Standard_G4",
        "Standard_G5",
        "Standard_GS1",
        "Standard_GS2",
        "Standard_GS3",
        "Standard_GS4",
        "Standard_GS5",
        "Standard_H8",
        "Standard_H16",
        "Standard_H8m",
        "Standard_H16m",
        "Standard_H16mr",
        "Standard_H16r",
        "Standard_L4",
        "Standard_L8",
        "Standard_L16",
        "Standard_L32"
      ],
      "type": "string",
      "metadata": {
        "description": "Size of the worker nodes."
      }
    },
    "workerNodeOsDiskType": {
      "defaultValue": "Standard_LRS",
      "allowedValues": [
        "Standard_LRS",
        "StandardSSD_LRS",
        "Premium_LRS"
      ],
      "type": "string",
      "metadata": {
        "description": "Head node OS Disk Account type"
      }
    },
    "workerNodeCount": {
      "defaultValue": 2,
      "type": "int",
      "metadata": {
        "description": "This template creates N worker node. Use workerNodeCount to specify that N."
      }
    },
    "dataDiskSize": {
      "defaultValue": 32,
      "allowedValues": [
        32,
        64,
        128,
        256,
        512,
        1024,
        2048,
        4096
      ],
      "type": "int",
      "metadata": {
        "description": "The size in GB of each data disk that is attached to the VM.  A RAID-0 volume is created with all data disks that is dataDiskSize * dataDiskCount in size."
      }
    },
    "headNodeDataDiskCount": {
      "defaultValue": 1,
      "allowedValues": [
        1,
        2,
        4,
        8
      ],
      "type": "int",
      "metadata": {
        "description": "The size in GB of each data disk that is attached to the VM.  A RAID-0 volume is created with all data disks that is dataDiskSize * dataDiskCount in size."
      }
    },
    "headNodeDataDiskType": {
      "defaultValue": "Standard_LRS",
      "allowedValues": [
        "Standard_LRS",
        "StandardSSD_LRS",
        "Premium_LRS",
        "UltraSSD_LRS"
      ],
      "type": "string",
      "metadata": {
        "description": "Head node OS Disk Account type"
      }
    },
    "workerNodeDataDiskCount": {
      "defaultValue": 1,
      "allowedValues": [
        1,
        2,
        4,
        8
      ],
      "type": "int",
      "metadata": {
        "description": "The size in GB of each data disk that is attached to the VM.  A RAID-0 volume is created with all data disks that is dataDiskSize * dataDiskCount in size."
      }
    },
    "workerNodeDataDiskType": {
      "defaultValue": "Standard_LRS",
      "allowedValues": [
        "Standard_LRS",
        "StandardSSD_LRS",
        "Premium_LRS",
        "UltraSSD_LRS"
      ],
      "type": "string",
      "metadata": {
        "description": "Head node OS Disk Account type"
      }
    },
    "installEasybuild": {
      "defaultValue": "No",
      "allowedValues": [
        "Yes",
        "No"
      ],
      "type": "string",
      "metadata": {
        "description": "Install the EasyBuild framework."
      }
    },
    "clusterFilesystem": {
      "defaultValue": "None:None",
      "allowedValues": [
        "BeeGFS:Storage",
        "BeeGFS:SSD",
        "None:None"
      ],
      "type": "string",
      "metadata": {
        "description": "Path to use for BeeGFS storage."
      }
    }
  },
  "variables": {
    "frontendServicePlanSkuParts": "[split(parameters('frontendServiceSku'), ' ')]",
    "appServicePlanSku": {
      "name": "[variables('frontendServicePlanSkuParts')[0]]",
      "tier": "[variables('frontendServicePlanSkuParts')[1]]"
    },
    "linuxNodeImages": {
      "CentOS_7.1": {
        "publisher": "OpenLogic",
        "offer": "CentOS",
        "sku": "7.1",
        "version": "latest"
      },
      "CentOS_7.3": {
        "publisher": "OpenLogic",
        "offer": "CentOS",
        "sku": "7.3",
        "version": "latest"
      },
      "CentOS_7.4": {
        "publisher": "OpenLogic",
        "offer": "CentOS",
        "sku": "7.4",
        "version": "latest"
      },
      "CentOS_7.1_HPC": {
        "publisher": "OpenLogic",
        "offer": "CentOS-HPC",
        "sku": "7.1",
        "version": "latest"
      },
      "CentOS_7.3_HPC": {
        "publisher": "OpenLogic",
        "offer": "CentOS-HPC",
        "sku": "7.3",
        "version": "latest"
      },
      "CentOS_7.4_HPC": {
        "publisher": "OpenLogic",
        "offer": "CentOS-HPC",
        "sku": "7.4",
        "version": "latest"
      },
      "RHEL_7.3": {
        "publisher": "RedHat",
        "offer": "RHEL",
        "sku": "7.3",
        "version": "latest"
      },
      "RHEL_7.4": {
        "publisher": "RedHat",
        "offer": "RHEL",
        "sku": "7.4",
        "version": "latest"
      }
    },
    "artifactsBaseUrl": "https://raw.githubusercontent.com/sunbinzhu/azure-hpc/master/Templates/hpc-cluster/"
  },
  "resources": [
    {
      "apiVersion": "2018-05-01",
      "type": "Microsoft.Resources/deployments",
      "name": "mainTemplate",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[uri(variables('artifactsBaseUrl'), 'mainTemplate.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "portalDnsNameLabel": {
            "value": "[parameters('portalDnsNameLabel')]"
          },
          "appServicePlanPricingTier": {
            "value": "[variables('appServicePlanSku')]"
          },
          "portalAnonymousAccess": {
            "value": "[equals(parameters('portalAnonymousAccess'), 'Yes')]"
          },
          "aadAuthApplicationId": {
            "value": "[parameters('aadAuthApplicationId')]"
          },
          "aadTenantId": {
            "value": "[parameters('aadTenantId')]"
          },
          "frontendImageName": {
            "value": "[parameters('frontendImageName')]"
          },
          "jobMonitorImageName": {
            "value": "[parameters('jobMonitorImageName')]"
          },
          "jobMonitorCpuCores": {
            "value": "[parameters('jobMonitorCpuCores')]"
          },
          "jobMonitorMemoryInGb": {
            "value": "[parameters('jobMonitorMemoryInGb')]"
          },
          "taskDispatcherImageName": {
            "value": "[parameters('taskDispatcherImageName')]"
          },
          "taskDispatcherCpuCores": {
            "value": "[parameters('taskDispatcherCpuCores')]"
          },
          "taskDispatcherMemoryInGb": {
            "value": "[parameters('taskDispatcherMemoryInGb')]"
          },
          "dashboardImageName": {
            "value": "[parameters('dashboardImageName')]"
          },
          "dashboardCpuCores": {
            "value": "[parameters('dashboardCpuCores')]"
          },
          "dashboardMemoryInGb": {
            "value": "[parameters('dashboardMemoryInGb')]"
          },
          "scheduler": {
            "value": "[parameters('scheduler')]"
          },
          "adminUserName": {
            "value": "[parameters('adminUserName')]"
          },
          "adminPassword": {
            "value": "[if(equals(parameters('scheduler'), 'None'), uniqueString(resourceGroup().id), parameters('adminPassword'))]"
          },
          "hpcUserName": {
            "value": "[parameters('hpcUserName')]"
          },
          "hpcNodeImage": {
            "value": "[variables('linuxNodeImages')[parameters('hpcNodeImage')]]"
          },
          "headNodeName": {
            "value": "[parameters('headNodeName')]"
          },
          "headNodeSize": {
            "value": "[parameters('headNodeSize')]"
          },
          "headNodeOsDiskType": {
            "value": "[parameters('headNodeOsDiskType')]"
          },
          "headNodeDataDiskType": {
            "value": "[parameters('headNodeDataDiskType')]"
          },
          "workerNodeNamePrefix": {
            "value": "[parameters('workerNodeNamePrefix')]"
          },
          "workerNodeSize": {
            "value": "[parameters('workerNodeSize')]"
          },
          "workerNodeCount": {
            "value": "[parameters('workerNodeCount')]"
          },
          "workerNodeOsDiskType": {
            "value": "[parameters('workerNodeOsDiskType')]"
          },
          "workerNodeDataDiskCount": {
            "value": "[parameters('workerNodeDataDiskCount')]"
          },
          "workerNodeDataDiskType": {
            "value": "[parameters('workerNodeDataDiskType')]"
          },
          "dataDiskSize": {
            "value": "[parameters('dataDiskSize')]"
          },
          "installEasybuild": {
            "value": "[parameters('installEasybuild')]"
          },
          "clusterFilesystem": {
            "value": "[parameters('clusterFilesystem')]"
          },
          "location": {
            "value": "[resourceGroup().location]"
          },
          "_artifactsLocation": {
            "value": "[variables('artifactsBaseUrl')]"
          }
        }
      }
    }
  ],
  "outputs": {
    "portalUri": {
      "type": "string",
      "value": "[reference('mainTemplate').outputs.portalUri.value]"
    }
  }
}